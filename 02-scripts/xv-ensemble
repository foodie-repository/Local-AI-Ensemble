#!/usr/bin/env bash
set -euo pipefail

# Ensure we are in the git root
cd "$(git rev-parse --show-toplevel)" || exit 1

# 공통 함수 로드
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${SCRIPT_DIR}/xv-common"

REPORT_FILE="${1:-}"

if [ -z "$REPORT_FILE" ]; then
    echo "Usage: $0 <path_to_report.md>"
    echo "Example: $0 ai-ensemble/reports/20240101_120000/report.md"
    exit 1
fi

if [ ! -f "$REPORT_FILE" ]; then
    echo "Error: Report file not found: $REPORT_FILE"
    exit 1
fi

REPORT_CONTENT=$(cat "$REPORT_FILE")
REPORT_DIR=$(dirname "$REPORT_FILE")

# Prepare ensemble prompt
PROMPT_TEMPLATE="ai-ensemble/custom-prompts/ensemble.md"
SYSTEM_PROMPT="01-system-prompts/ensemble.md"

load_prompt_template "$PROMPT_TEMPLATE" "$SYSTEM_PROMPT" || exit 1

# Gemini를 앙상블 리드로 사용 (대용량 컨텍스트 윈도우 활용)

PROMPT_FILE="${REPORT_DIR}/ensemble_prompt.txt"

# 플레이스홀더 치환
export REPORT_CONTENT
CONTEXT_ARG="AI 리뷰 앙상블"
export CONTEXT_ARG

if command -v python3 &> /dev/null; then
    if python3 -c "
import sys
import os

template_path = '$PROMPT_TEMPLATE'
context_arg = os.environ.get('CONTEXT_ARG', '')
report_content = os.environ.get('REPORT_CONTENT', '')

try:
    with open(template_path, 'r') as f:
        template = f.read()

    output = template.replace('{{CONTEXT_ARG}}', context_arg).replace('{{REPORT_CONTENT}}', report_content)

    with open('$PROMPT_FILE', 'w') as f:
        f.write(output)
except Exception as e:
    sys.exit(1)
"; then
        : # 템플릿 처리 성공
    else
        echo "템플릿 처리 실패. 기본 형식으로 생성합니다."
        cat <<EOF > "$PROMPT_FILE"
아래 AI 리뷰들을 종합하여 최종 결정을 내려주세요.

리뷰 내용:
$REPORT_CONTENT
EOF
    fi
else
    cat <<EOF > "$PROMPT_FILE"
아래 AI 리뷰들을 종합하여 최종 결정을 내려주세요.

리뷰 내용:
$REPORT_CONTENT
EOF
fi

GEMINI_MODEL=$(get_model_info gemini)
echo "${GEMINI_MODEL}(으)로 앙상블 진행 중..."
ENSEMBLE_OUTPUT="${REPORT_DIR}/final_decision.md"

if gemini -o text < "$PROMPT_FILE" > "$ENSEMBLE_OUTPUT" 2>"${REPORT_DIR}/ensemble.err"; then
    echo "앙상블 완료: $ENSEMBLE_OUTPUT"
    
    # 에디터에서 결과 열기
    open_in_editor "$ENSEMBLE_OUTPUT"
else
    echo "앙상블 실패."
    exit 1
fi
