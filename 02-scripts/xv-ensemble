#!/usr/bin/env bash

# Ensure we are in the git root
cd "$(git rev-parse --show-toplevel)" || exit 1

REPORT_FILE="$1"

if [ -z "$REPORT_FILE" ]; then
    echo "Usage: $0 <path_to_report.md>"
    echo "Example: $0 ai-ensemble/reports/20240101_120000/report.md"
    exit 1
fi

if [ ! -f "$REPORT_FILE" ]; then
    echo "Error: Report file not found: $REPORT_FILE"
    exit 1
fi

REPORT_CONTENT=$(cat "$REPORT_FILE")
REPORT_DIR=$(dirname "$REPORT_FILE")

# Prepare ensemble prompt
# 우선순위: 1) 프로젝트 커스텀 프롬프트 → 2) 시스템 프롬프트 원본에서 복사
PROMPT_TEMPLATE="ai-ensemble/custom-prompts/ensemble.md"
SYSTEM_PROMPT="01-system-prompts/ensemble.md"

if [ ! -f "$PROMPT_TEMPLATE" ]; then
    mkdir -p "$(dirname "$PROMPT_TEMPLATE")"
    if [ -f "$SYSTEM_PROMPT" ]; then
        cp "$SYSTEM_PROMPT" "$PROMPT_TEMPLATE"
        echo "커스텀 프롬프트 생성: $SYSTEM_PROMPT → $PROMPT_TEMPLATE"
    else
        echo "Error: 시스템 프롬프트를 찾을 수 없습니다: $SYSTEM_PROMPT"
        echo "install.sh를 먼저 실행해주세요."
        exit 1
    fi
fi

# We use Gemini as the ensemble lead (Ensemble Agent)
# Reason: Gemini 1.5 Pro has a large context window suitable for reading long reports.

PROMPT_FILE="${REPORT_DIR}/ensemble_prompt.txt"

# Replace placeholders
# Using python for safe replacement
if command -v python3 &> /dev/null; then
    python3 -c "
import sys
import os

template_path = '$PROMPT_TEMPLATE'
report_content = '''$REPORT_CONTENT'''
context_arg = 'Ensemble AI Reviews' # Or parse from report if needed

try:
    with open(template_path, 'r') as f:
        template = f.read()
    
    output = template.replace('{{CONTEXT_ARG}}', context_arg).replace('{{DIFF_CONTENT}}', report_content)
    
    with open('$PROMPT_FILE', 'w') as f:
        f.write(output)
except Exception as e:
    sys.exit(1)
"
else
    # Simple cat fallback
    cat <<EOF > "$PROMPT_FILE"
Ensemble the following AI reviews into a final decision.

Reviews:
$REPORT_CONTENT
EOF
fi

echo "Ensembling reviews using Gemini..."
ENSEMBLE_OUTPUT="${REPORT_DIR}/final_decision.md"

# Run Gemini
# Assuming gemini CLI takes file content via pipe or argument
cat "$PROMPT_FILE" | gemini -o text > "$ENSEMBLE_OUTPUT"

if [ $? -eq 0 ]; then
    echo "Ensemble complete: $ENSEMBLE_OUTPUT"
    
    # Automatically open the result in the user's editor
    if command -v antigravity &> /dev/null; then
        antigravity "$ENSEMBLE_OUTPUT"
    elif command -v code &> /dev/null; then
        code "$ENSEMBLE_OUTPUT"
    else
        open "$ENSEMBLE_OUTPUT"
    fi
else
    echo "Ensemble failed."
    exit 1
fi
