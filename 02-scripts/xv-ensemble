#!/usr/bin/env bash

# Ensure we are in the git root
cd "$(git rev-parse --show-toplevel)" || exit 1

REPORT_FILE="$1"

if [ -z "$REPORT_FILE" ]; then
    echo "Usage: $0 <path_to_report.md>"
    echo "Example: $0 ai-ensemble/reports/20240101_120000/report.md"
    exit 1
fi

if [ ! -f "$REPORT_FILE" ]; then
    echo "Error: Report file not found: $REPORT_FILE"
    exit 1
fi

REPORT_CONTENT=$(cat "$REPORT_FILE")
REPORT_DIR=$(dirname "$REPORT_FILE")

# Prepare ensemble prompt
# 우선순위: 1) 프로젝트 커스텀 프롬프트 → 2) 시스템 프롬프트 원본에서 복사
PROMPT_TEMPLATE="ai-ensemble/custom-prompts/ensemble.md"
SYSTEM_PROMPT="01-system-prompts/ensemble.md"

if [ ! -f "$PROMPT_TEMPLATE" ]; then
    mkdir -p "$(dirname "$PROMPT_TEMPLATE")"
    if [ -f "$SYSTEM_PROMPT" ]; then
        cp "$SYSTEM_PROMPT" "$PROMPT_TEMPLATE"
        echo "커스텀 프롬프트 생성: $SYSTEM_PROMPT → $PROMPT_TEMPLATE"
    else
        echo "Error: 시스템 프롬프트를 찾을 수 없습니다: $SYSTEM_PROMPT"
        echo "install.sh를 먼저 실행해주세요."
        exit 1
    fi
fi

# We use Gemini as the ensemble lead (Ensemble Agent)
# Reason: Gemini 1.5 Pro has a large context window suitable for reading long reports.

PROMPT_FILE="${REPORT_DIR}/ensemble_prompt.txt"

# 플레이스홀더 치환
export REPORT_CONTENT
CONTEXT_ARG="AI 리뷰 앙상블"
export CONTEXT_ARG

if command -v python3 &> /dev/null; then
    python3 -c "
import sys
import os

template_path = '$PROMPT_TEMPLATE'
context_arg = os.environ.get('CONTEXT_ARG', '')
report_content = os.environ.get('REPORT_CONTENT', '')

try:
    with open(template_path, 'r') as f:
        template = f.read()

    output = template.replace('{{CONTEXT_ARG}}', context_arg).replace('{{DIFF_CONTENT}}', report_content)

    with open('$PROMPT_FILE', 'w') as f:
        f.write(output)
except Exception as e:
    sys.exit(1)
"
else
    cat <<EOF > "$PROMPT_FILE"
아래 AI 리뷰들을 종합하여 최종 결정을 내려주세요.

리뷰 내용:
$REPORT_CONTENT
EOF
fi

echo "Gemini로 앙상블 진행 중..."
ENSEMBLE_OUTPUT="${REPORT_DIR}/final_decision.md"

cat "$PROMPT_FILE" | gemini -o text > "$ENSEMBLE_OUTPUT" 2>/dev/null

if [ $? -eq 0 ]; then
    echo "앙상블 완료: $ENSEMBLE_OUTPUT"
    
    # Automatically open the result in the user's editor
    if command -v antigravity &> /dev/null; then
        antigravity "$ENSEMBLE_OUTPUT"
    elif command -v code &> /dev/null; then
        code "$ENSEMBLE_OUTPUT"
    else
        open "$ENSEMBLE_OUTPUT"
    fi
else
    echo "앙상블 실패."
    exit 1
fi
