#!/usr/bin/env bash

# Ensure we are in the git root
cd "$(git rev-parse --show-toplevel)" || exit 1

# Timestamp for report directory
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
REPORT_DIR="ai-ensemble/reports/${TIMESTAMP}"
mkdir -p "$REPORT_DIR"

# Determine context (Staged diff or specific file)
CONTEXT_ARG="$1"
DIFF_CONTENT=""
TARGET_FILE=""

if [[ "$CONTEXT_ARG" == *"파일"* && "$CONTEXT_ARG" == *"리뷰"* ]]; then
    # "파일 <filepath> 리뷰" 형식에서 파일 경로 추출
    TARGET_FILE=$(echo "$CONTEXT_ARG" | sed -E 's/파일 (.*) 리뷰/\1/')
    if [ -f "$TARGET_FILE" ]; then
        echo "파일 검증 중: $TARGET_FILE"
        DIFF_CONTENT=$(cat "$TARGET_FILE")
    else
        echo "Error: 파일을 찾을 수 없습니다: $TARGET_FILE"
        exit 1
    fi
else
    # Staged 변경사항 검증, 없으면 Working tree 검증
    echo "Staged 변경사항 검증 중..."
    if git diff --cached --quiet; then
        echo "Staged 변경사항 없음. Working tree 확인 중..."
        DIFF_CONTENT=$(git diff)
    else
        DIFF_CONTENT=$(git diff --cached)
    fi
    
    if [ -z "$DIFF_CONTENT" ]; then
        echo "검증할 변경사항이 없습니다."
        exit 0
    fi
fi


# Prepare prompt content
# 우선순위: 1) 프로젝트 커스텀 프롬프트 → 2) 시스템 프롬프트 원본에서 복사
PROMPT_TEMPLATE="ai-ensemble/custom-prompts/review.md"
SYSTEM_PROMPT="01-system-prompts/default_review.md"

if [ ! -f "$PROMPT_TEMPLATE" ]; then
    mkdir -p "$(dirname "$PROMPT_TEMPLATE")"
    if [ -f "$SYSTEM_PROMPT" ]; then
        cp "$SYSTEM_PROMPT" "$PROMPT_TEMPLATE"
        echo "커스텀 프롬프트 생성: $SYSTEM_PROMPT → $PROMPT_TEMPLATE"
    else
        echo "Error: 시스템 프롬프트를 찾을 수 없습니다: $SYSTEM_PROMPT"
        echo "install.sh를 먼저 실행해주세요."
        exit 1
    fi
fi

PROMPT_FILE="${REPORT_DIR}/prompt.txt"

# 플레이스홀더 치환 (python3 사용, 없으면 fallback)
export CONTEXT_ARG DIFF_CONTENT
if command -v python3 &> /dev/null; then
    python3 -c "
import sys
import os

template_path = '$PROMPT_TEMPLATE'
context_arg = os.environ.get('CONTEXT_ARG', '')
diff_content = os.environ.get('DIFF_CONTENT', '')

try:
    with open(template_path, 'r') as f:
        template = f.read()
    
    # Simple replacement
    output = template.replace('{{CONTEXT_ARG}}', context_arg).replace('{{DIFF_CONTENT}}', diff_content)
    
    with open('$PROMPT_FILE', 'w') as f:
        f.write(output)
except Exception as e:
    sys.exit(1)
"
    if [ $? -ne 0 ]; then
        echo "템플릿 처리 실패. 기본 형식으로 생성합니다."
        cat <<EOF > "$PROMPT_FILE"
리뷰 컨텍스트: $CONTEXT_ARG
코드:
$DIFF_CONTENT
EOF
    fi
else
    cat <<EOF > "$PROMPT_FILE"
리뷰 컨텍스트: $CONTEXT_ARG
코드:
$DIFF_CONTENT
EOF
fi

echo "프롬프트 생성 완료: $PROMPT_FILE"

# Calculate Prompt Hash for Traceability
if command -v shasum &> /dev/null; then
    PROMPT_HASH=$(shasum -a 256 "$PROMPT_FILE" | awk '{print $1}')
elif command -v sha256sum &> /dev/null; then
    PROMPT_HASH=$(sha256sum "$PROMPT_FILE" | awk '{print $1}')
else
    PROMPT_HASH=$(md5 -q "$PROMPT_FILE") # macOS fallback
fi

# Claude, Codex, Gemini 병렬 실행
echo "Claude, Codex, Gemini 실행 중..."
PROMPT_CONTENT=$(cat "$PROMPT_FILE")

(unset CLAUDECODE; claude -p "$PROMPT_CONTENT" > "${REPORT_DIR}/claude.txt" 2>/dev/null) &
CLAUDE_PID=$!

(echo "$PROMPT_CONTENT" | codex exec - > "${REPORT_DIR}/codex.txt" 2>/dev/null) &
CODEX_PID=$!

(echo "$PROMPT_CONTENT" | gemini -o text > "${REPORT_DIR}/gemini.txt" 2>/dev/null) &
GEMINI_PID=$!

wait $CLAUDE_PID
wait $CODEX_PID
wait $GEMINI_PID

# 응답 검증
WARNINGS=""

if [ ! -s "${REPORT_DIR}/claude.txt" ]; then
    WARNINGS="${WARNINGS}\n- Claude: 응답 없음"
fi
if [ ! -s "${REPORT_DIR}/codex.txt" ]; then
    WARNINGS="${WARNINGS}\n- Codex: 응답 없음"
fi
if [ ! -s "${REPORT_DIR}/gemini.txt" ]; then
    WARNINGS="${WARNINGS}\n- Gemini: 응답 없음"
fi

# Validator 실행 (환경변수가 설정된 경우)
VALIDATOR_FAIL=0
if [ -n "$LINT_CMD" ]; then
    echo "Lint 실행: $LINT_CMD"
    eval "$LINT_CMD" || VALIDATOR_FAIL=1
fi
if [ -n "$TYPECHECK_CMD" ]; then
    echo "타입체크 실행: $TYPECHECK_CMD"
    eval "$TYPECHECK_CMD" || VALIDATOR_FAIL=1
fi
if [ -n "$TEST_CMD" ]; then
    echo "테스트 실행: $TEST_CMD"
    eval "$TEST_CMD" || VALIDATOR_FAIL=1
fi

if [ $VALIDATOR_FAIL -ne 0 ]; then
    echo "Validator 실패."
    exit 1
fi

# Generate Report MD
REPORT_MD="${REPORT_DIR}/report.md"
cat <<EOF > "$REPORT_MD"
# AI Code Review Report
**Date:** $(date)
**Context:** $CONTEXT_ARG
**Prompt Hash:** \`$PROMPT_HASH\`

## Status
$WARNINGS

## Claude Response
$(cat "${REPORT_DIR}/claude.txt" 2>/dev/null || echo "No output")

---

## Codex Response
$(cat "${REPORT_DIR}/codex.txt" 2>/dev/null || echo "No output")

---

## Gemini Response
$(cat "${REPORT_DIR}/gemini.txt" 2>/dev/null || echo "No output")
EOF

echo "리포트 생성 완료: $REPORT_MD"

# 에디터에서 리포트 열기
if command -v antigravity &> /dev/null; then
    antigravity "$REPORT_MD"
elif command -v code &> /dev/null; then
    code "$REPORT_MD"
else
    open "$REPORT_MD"
fi

exit 0
