#!/bin/bash

# Ensure we are in the git root
cd "$(git rev-parse --show-toplevel)" || exit 1

REPORT_FILE="$1"

if [ -z "$REPORT_FILE" ]; then
    echo "Usage: $0 <path_to_report.md>"
    echo "Example: $0 .ai-check/reports/20240101_120000/report.md"
    exit 1
fi

if [ ! -f "$REPORT_FILE" ]; then
    echo "Error: Report file not found: $REPORT_FILE"
    exit 1
fi

REPORT_CONTENT=$(cat "$REPORT_FILE")
REPORT_DIR=$(dirname "$REPORT_FILE")

# Prepare ensemble prompt
PROMPT_TEMPLATE=".ai-check/prompts/ensemble.md"
if [ ! -f "$PROMPT_TEMPLATE" ]; then
    echo "Error: Ensemble prompt template not found at $PROMPT_TEMPLATE"
    exit 1
fi

# We use Gemini as the ensemble lead (Ensemble Agent)
# Reason: Gemini 1.5 Pro has a large context window suitable for reading long reports.

PROMPT_FILE="${REPORT_DIR}/ensemble_prompt.txt"

# Replace placeholders
# Using python for safe replacement
if command -v python3 &> /dev/null; then
    python3 -c "
import sys
import os

template_path = '$PROMPT_TEMPLATE'
report_content = '''$REPORT_CONTENT'''
context_arg = 'Ensemble AI Reviews' # Or parse from report if needed

try:
    with open(template_path, 'r') as f:
        template = f.read()
    
    output = template.replace('{{CONTEXT_ARG}}', context_arg).replace('{{DIFF_CONTENT}}', report_content)
    
    with open('$PROMPT_FILE', 'w') as f:
        f.write(output)
except Exception as e:
    sys.exit(1)
"
else
    # Simple cat fallback
    cat <<EOF > "$PROMPT_FILE"
Ensemble the following AI reviews into a final decision.

Reviews:
$REPORT_CONTENT
EOF
fi

echo "Ensembling reviews using Gemini..."
ENSEMBLE_OUTPUT="${REPORT_DIR}/final_decision.md"

# Run Gemini
# Assuming gemini CLI takes file content via pipe or argument
cat "$PROMPT_FILE" | gemini -o text > "$ENSEMBLE_OUTPUT"

if [ $? -eq 0 ]; then
    echo "Ensemble complete: $ENSEMBLE_OUTPUT"
    
    # Automatically open the result
    if command -v code &> /dev/null; then
        code "$ENSEMBLE_OUTPUT"
    else
        open "$ENSEMBLE_OUTPUT"
    fi
else
    echo "Ensemble failed."
    exit 1
fi
